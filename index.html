
<html lang="en">
    <head>
      <link href="site.css" rel="stylesheet">

      <!-- This needs moved to the css file -->
      <style>
      [contenteditable]:hover:after {
        content: 'Click to change name';
        color: #000;
      }

      [contenteditable]:hover, [contenteditable]:focus {
        background: #FFFFFF;
      }

      [contenteditable]:focus {
        content: '';
        background: #000000;
      }

      [contenteditable]:focus:after {
        content: '';
      }
      </style>
      <!-- This needs moved to the css file -->


    </head>
    <body>
      <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
      <script src="/socket.io/socket.io.js"></script>

      <div id="myname" class="name">
        <p contenteditable data-name="myname" id="name">YOUR NAME</p>
      </div>

      <div id="rectangle" style="background-color:red"><div id="mystatus" class="status">YOUR TURN</div> </div>
      <div id="my_uuid"> Not connected!  </div>
      <div id="position"> ERROR! </div>

      <!-- ORDERING IS IMPORTANT since document might not be ready.-->
      <!-- ACTIVE DUTY -->
      <div id="activeMaps" width=100%>
        <div id="dust11" class="map" style="background: url('dust2.png')"> <div class="row"> <div class="map_name">dust11</div></div></div>
        <div id="cobblestone" class="map" style="background: url('cobblestone.png')"> <div class="row"> <div class="map_name">cobblestone</div></div></div>
        <div id="inferno" class="map" style="background: url('inferno.png')"> <div class="row"> <div class="map_name">inferno</div></div></div>
        <div id="cache" class="map" style="background: url('cache.png')"> <div class="row"> <div class="map_name">cache</div></div></div>
        <div id="mirage" class="map" style="background: url('mirage.png')"> <div class="row"> <div class="map_name">mirage</div></div></div>
        <div id="overpass" class="map" style="background: url('overpass.png')"> <div class="row"> <div class="map_name">overpass</div></div></div>
        <div id="train" class="map" style="background: url('train.png')"> <div class="row"> <div class="map_name">train</div></div></div>
      </div>
      <!-- ACTIVE DUTY -->

      <!-- RESERVES -->
      <div id="reserveMaps">
        <div id="nuke" class="map" style="background: url('nuke.png')"> <div class="row"> <div class="map_name">nuke</div></div></div>
        <div id="assault" class="map" style="background: url('assault.png')"> <div class="row"> <div class="map_name">assault</div></div></div>
        <div id="dust" class="map" style="background: url('dust.png')"> <div class="row"> <div class="map_name">dust</div></div></div>
        <div id="vertigo" class="map" style="background: url('vertigo.png')"> <div class="row"> <div class="map_name">vertigo</div></div></div>
        <div id="militia" class="map" style="background: url('militia.png')"> <div class="row"> <div class="map_name">militia</div></div></div>
        <div id="italy" class="map" style="background: url('italy.png')"> <div class="row"> <div class="map_name">italy</div></div></div>
        <div id="office" class="map" style="background: url('office.png')"> <div class="row"> <div class="map_name">office</div></div></div>
        <div id="aztec" class="map" style="background: url('aztec.png')"> <div class="row"> <div class="map_name">aztec</div></div></div>
      </div>
      <!-- RESERVES -->




      <!-- ORDERING IS IMPORTANT -->

      <script>

      var total_maps = 15
      var firstClient = 0 ;
      var inCharge = false;
      var mapCache = [];
      var myName = "YOUR NAME";

      //Initiate connection to server
      var host = window.location.origin
      var socket = io.connect(host);

      // Create random uuid
      function guid() {
        function s4() {
          return Math.floor((1 + Math.random()) * 0x10000)
          .toString(16)
          .substring(1);
        }
        return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
        s4() + '-' + s4() + s4() + s4();
      }

      // function to grey out a specified div
      function greyDiv(map) {
        selector = "#" + map
        $(selector).css('background-color', 'grey');
        $(selector).css('opacity', '0.4');
        $(selector).unbind();
      }

      // handle live edit ENTER and ESC keys
      document.addEventListener('keydown', function (event) {
        var esc = event.which == 27,
        nl = event.which == 13,
        el = event.target,
        input = el.nodeName != 'INPUT' && el.nodeName != 'TEXTAREA',
        data = {};

        if (input) {
          if (esc) {
            // restore state
            document.execCommand('undo');
            el.blur();
          } else if (nl) {
            // save
            data[el.getAttribute('data-name')] = el.innerHTML;

            // Send the actual request
            if ( data.myname == myName ) {
                //do nothing
            } else {
              socket.emit('name change', data.myname);
            }

            el.blur();
            event.preventDefault();
          }
        }
      }, true);

      //Wipe name after clicking to change
      $('#myname>p').click(
        function(){
          $(this).text('');
      });


      socket.on('connect', function(data) {
        uuid = guid();
        socket.emit('add user', uuid);
        $("#my_uuid").text(uuid);
      });

      socket.on('order_changed',function(data){
        console.log(data + ' gets to choose');

        if ( uuid == data ) {
          $('#rectangle').css('background-color', 'green');
          $('#rectangle>.status').text('YOUR TURN');
          inCharge = true;
        } else {
          $('#rectangle').css('background-color', 'red');
          $('#rectangle>.status').text('WAITING ON: ' + data);
          inCharge = false;
        }
        $("#position").text(data);
      });

      // Whenever the server emits 'user joined', log it in the chat body
      socket.on('user joined', function (data) {
        console.log(data.username  + ' joined');
      });

      socket.on('user left', function (data) {
        console.log(data.username + ' left');
      });


      socket.on('update cache', function (data) {
        mapCache = data;
        total_maps = total_maps - mapCache.length;
        jQuery.each(mapCache,function(i,val){ greyDiv(val)});
      });

      socket.on('map_selected', function (data) {
        console.log("Map "+ data + " was removed");
        greyDiv(data);
        mapCache.push(data)
        --total_maps;
        console.log ("maps left:"+total_maps)
        if ( total_maps == 1 ) { inCharge = false; }
      });

      // Define buttons
      $('.map').each(function(index) {
        $(this).click(function() {
          if (inCharge && total_maps > 1) {
            //console.log("clicking on:"+$(this).attr('id'))
            socket.emit('make_selection', {uuid: $("#my_uuid").text(), map: $(this).attr('id')})
          }
          else {
            console.log ("Tried to click without inCharge");
          }

        });
      });

      </script>
    </body>
</html>
